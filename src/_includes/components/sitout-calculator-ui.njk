{% set statusValue = calculatorContext.initialResult.status %}
{% set statusToneClass = "ring-1 ring-amber-400/30 bg-amber-400/5" %}
{% if statusValue == "SAFE" %}
{% set statusToneClass = "ring-1 ring-emerald-400/30 bg-emerald-400/5" %}
{% elif statusValue == "DISCARD" %}
{% set statusToneClass = "ring-1 ring-rose-400/30 bg-rose-400/5" %}
{% endif %}

<div class="grid grid-cols-1 gap-6 lg:grid-cols-12">
  <div class="space-y-6 lg:col-span-5">
    {% set cardVariant = "elevated" %}
    {% set cardClassName = "transition duration-200 ease-out hover:-translate-y-0.5 hover:shadow-xl" %}
    {% set cardContent %}
    <form method="get" action="/food-left-out-calculator/" data-calculator-form class="space-y-6">
      <section class="space-y-4">
        <h2 class="text-sm font-semibold uppercase tracking-wide text-muted">Food selection</h2>

        {% set fieldControl %}
        <select id="food_id" name="food_id" required aria-required="true" class="w-full rounded-xl border border-border bg-surfaceElevated px-3 py-2 text-sm">
          <option value="">Select a food</option>
          {% for food in foods.items %}
          <option
            value="{{ food.food_id }}"
            {% if calculatorContext.initialInput.food_id == food.food_id %}selected{% endif %}
          >
            {{ food.name }}
          </option>
          {% endfor %}
        </select>
        {% endset %}
        {% set fieldId = "food_id" %}
        {% set fieldLabel = "Food" %}
        {% include "components/ui-field.njk" %}

        <div
          data-state-wrap
          {% if not (calculatorContext.initialInput.food_id and foods.byId[calculatorContext.initialInput.food_id] and foods.byId[calculatorContext.initialInput.food_id].states.length) %}hidden{% endif %}
        >
          {% set fieldControl %}
          <select id="state" name="state" data-state-select class="w-full rounded-xl border border-border bg-surfaceElevated px-3 py-2 text-sm">
            <option value="">Select state</option>
            {% if calculatorContext.initialInput.food_id and foods.byId[calculatorContext.initialInput.food_id] %}
            {% for stateEntry in foods.byId[calculatorContext.initialInput.food_id].states %}
            <option
              value="{{ stateEntry.state }}"
              {% if calculatorContext.initialInput.state == stateEntry.state %}selected{% endif %}
            >
              {{ stateEntry.label }}
            </option>
            {% endfor %}
            {% endif %}
          </select>
          {% endset %}
          {% set fieldId = "state" %}
          {% set fieldLabel = "State" %}
          {% include "components/ui-field.njk" %}
        </div>
      </section>

      <section class="space-y-4">
        <h2 class="text-sm font-semibold uppercase tracking-wide text-muted">Conditions</h2>

        {% set fieldControl %}
        <input
          id="temp_value"
          name="temp_value"
          type="number"
          step="0.1"
          value="{{ calculatorContext.initialInput.temp_value }}"
          required
          aria-required="true"
          class="w-full rounded-xl border border-border bg-surfaceElevated px-3 py-2 text-sm"
        />
        <fieldset class="mt-3 flex gap-4">
          <legend class="mb-1 text-xs uppercase tracking-wide text-muted">Unit</legend>
          <label class="inline-flex items-center gap-2 text-sm">
            <input
              type="radio"
              name="temp_unit"
              value="F"
              {% if calculatorContext.initialInput.temp_unit == "F" %}checked{% endif %}
            />
            Fahrenheit
          </label>
          <label class="inline-flex items-center gap-2 text-sm">
            <input
              type="radio"
              name="temp_unit"
              value="C"
              {% if calculatorContext.initialInput.temp_unit == "C" %}checked{% endif %}
            />
            Celsius
          </label>
        </fieldset>
        {% endset %}
        {% set fieldId = "temp_value" %}
        {% set fieldLabel = "Temperature" %}
        {% include "components/ui-field.njk" %}

        <fieldset class="space-y-2 rounded-2xl border border-white/10 bg-white/5 p-4">
          <legend class="px-2 text-xs uppercase tracking-wide text-muted">Modifiers</legend>
          <label for="covered" class="inline-flex items-center gap-2 text-sm">
            <input
              id="covered"
              name="covered"
              type="checkbox"
              value="1"
              {% if calculatorContext.initialInput.covered %}checked{% endif %}
            />
            Food was covered
          </label>
          <label for="high_risk_consumer" class="inline-flex items-center gap-2 text-sm">
            <input
              id="high_risk_consumer"
              name="high_risk_consumer"
              type="checkbox"
              value="1"
              {% if calculatorContext.initialInput.high_risk_consumer %}checked{% endif %}
            />
            High-risk consumer (pregnant, elderly, immunocompromised)
          </label>
        </fieldset>
      </section>

      <section class="space-y-4">
        <h2 class="text-sm font-semibold uppercase tracking-wide text-muted">Exposure</h2>
        <div class="grid gap-4 sm:grid-cols-2">
          {% set fieldControl %}
          <input
            id="hours"
            name="hours"
            type="number"
            min="0"
            value="{{ calculatorContext.initialInput.hours }}"
            required
            aria-required="true"
            class="w-full rounded-xl border border-border bg-surfaceElevated px-3 py-2 text-sm"
          />
          {% endset %}
          {% set fieldId = "hours" %}
          {% set fieldLabel = "Hours left out" %}
          {% include "components/ui-field.njk" %}

          {% set fieldControl %}
          <input
            id="minutes"
            name="minutes"
            type="number"
            min="0"
            value="{{ calculatorContext.initialInput.minutes }}"
            required
            aria-required="true"
            class="w-full rounded-xl border border-border bg-surfaceElevated px-3 py-2 text-sm"
          />
          {% endset %}
          {% set fieldId = "minutes" %}
          {% set fieldLabel = "Minutes left out" %}
          {% include "components/ui-field.njk" %}
        </div>
      </section>

      {% set buttonVariant = "primary" %}
      {% set buttonType = "submit" %}
      {% set buttonLabel = "Calculate" %}
      {% include "components/ui-button.njk" %}
    </form>
    {% endset %}
    {% include "components/ui-card.njk" %}
  </div>

  <div class="space-y-6 lg:col-span-7">
    <div class="space-y-6 lg:sticky lg:top-24">
      {% set cardVariant = "elevated" %}
      {% set cardClassName = "transition duration-200 ease-out hover:-translate-y-0.5 hover:shadow-xl" %}
      {% set cardContent %}
      <section aria-live="polite" data-results class="space-y-4">
        <h2>Result</h2>
        <div data-result-hero class="rounded-2xl p-5 {{ statusToneClass }}">
          <p class="text-xs uppercase tracking-wider text-muted">Current status</p>
          <p class="text-2xl font-semibold tracking-tight" data-result-status>{{ calculatorContext.initialResult.status }}</p>
          <p class="mt-4 text-xs uppercase tracking-wider text-muted">Safe limit</p>
          <p class="text-3xl font-semibold tracking-tight" data-result-limit>{{ calculatorContext.initialResult.conservative_safe_limit_label }}</p>
        </div>

        <p>
          Applied rule:
          <strong data-result-rule>
            {% if calculatorContext.initialResult.matched_rule %}
            {{ calculatorContext.initialResult.matched_rule.rule_id }} ({{ calculatorContext.initialResult.matched_rule.applies_to }})
            {% else %}
            No matching rule
            {% endif %}
          </strong>
        </p>

        <h3>Reasons</h3>
        <ul data-result-reasons class="list-disc space-y-1 pl-5">
          {% for reason in calculatorContext.initialResult.reasons %}
          <li>{{ reason }}</li>
          {% endfor %}
        </ul>

        <details class="rounded-xl border border-border bg-surfaceElevated/40 p-4">
          <summary class="cursor-pointer text-sm text-slate-300 transition duration-200 ease-out hover:text-text">
            Assumptions and conservative caveats
          </summary>
          <ul data-result-assumptions class="mt-3 list-disc space-y-1 pl-5 text-sm">
            {% for assumption in calculatorContext.initialResult.assumptions %}
            <li>{{ assumption }}</li>
            {% endfor %}
          </ul>
        </details>

        <p>
          Recommended action:
          <strong data-result-action>{{ calculatorContext.initialResult.recommended_action }}</strong>
        </p>
        <p>
          Read the <a href="/disclaimer/">disclaimer</a> before making food safety decisions.
        </p>
      </section>
      {% endset %}
      {% include "components/ui-card.njk" %}

      {% set affiliateBlock = {
        title: "Recommended tools (affiliate links)",
        products: calculatorContext.affiliateProducts,
        scenarioType: "sitout",
        status: calculatorContext.initialResult.status,
        hasDisclaimerAbove: true
      } %}
      {% include "components/affiliate-block.njk" %}

      {% set selectedFood = foods.byId[calculatorContext.initialInput.food_id] %}
      {% set cardVariant = "default" %}
      {% set cardContent %}
      <section data-next-scenario>
        <h2>Next scenario</h2>
        <p data-next-scenario-summary>
          {% if calculatorContext.initialResult.status == "DISCARD" %}
          Conservative result is discard. Use these next steps for safer storage decisions.
          {% else %}
          Explore related safety scenarios and conservative storage guidance.
          {% endif %}
        </p>
        <ul data-next-scenario-links class="list-disc space-y-1 pl-5">
          {% if calculatorContext.initialResult.status == "DISCARD" %}
          <li><a href="/printable-food-storage-chart/">Printable food storage chart</a></li>
          <li><a href="/thermometer-recommendations/">Thermometer recommendations</a></li>
          {% if selectedFood %}
          <li><a href="/how-long-does-{{ selectedFood.slug }}-last/">Food storage page for {{ selectedFood.name }}</a></li>
          {% else %}
          <li><a href="/methodology/">Methodology</a></li>
          {% endif %}
          {% else %}
          {% if selectedFood %}
          <li><a href="/how-long-does-{{ selectedFood.slug }}-last/">Food storage page for {{ selectedFood.name }}</a></li>
          {% endif %}
          <li><a href="/printable-food-storage-chart/">Printable food storage chart</a></li>
          <li><a href="/can-i-refreeze-this/">Can I refreeze this?</a></li>
          {% endif %}
        </ul>
      </section>
      {% endset %}
      {% include "components/ui-card.njk" %}
    </div>
  </div>
</div>

{% if calculatorContext.adContext.enabled %}
{% set adSlot = {
  enabled: true,
  zone: "bottom_page"
} %}
{% include "components/ad-slot.njk" %}
{% endif %}

{% set emailCapture = {
  id: "sitout-email-capture",
  title: "Get food safety updates",
  description: "Get notified when safety rules update, including seasonal alerts and chart changes.",
  source: "/food-left-out-calculator/"
} %}
{% include "components/email-capture.njk" %}

<script id="calculator-data" type="application/json">{{ calculatorContext.serialized | safe }}</script>
<script src="/assets/calculator-engine.js"></script>
<script src="/assets/js/sitout-calculator.js"></script>
